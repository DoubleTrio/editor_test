<v:ChromelessWindow xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:vm="using:AvaloniaTest.ViewModels"
                    xmlns:v="using:AvaloniaTest.Views"
                    xmlns:conv="using:AvaloniaTest.Converters"
                    xmlns:converters="using:Avalonia.Controls.Converters"
                    xmlns:views="clr-namespace:AvaloniaTest.Views"
                    xmlns:avconv="using:Avalonia.Controls.Converters"
                    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                    mc:Ignorable="d" d:DesignWidth="1024" d:DesignHeight="450"
                    x:Class="AvaloniaTest.Views.MainWindow"
                    x:DataType="vm:MainWindowViewModel"
                    x:Name="WindowMain"
                    
                    Icon="/Assets/avalonia-logo.ico"
                    xmlns:local="clr-namespace:AvaloniaTest.Converters"
                    Title="Avalonia PMD Editor">

    <Design.DataContext>
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <Window.Resources>

        <converters:MarginMultiplierConverter
            x:Key="CustomTreeViewItemLeftMarginConverter"
            Indent="3"
            Left="True" />
        <local:IconKeyToGeometryConverter x:Key="IconKeyConverter"/>
        <DataTemplate x:Key="NodeContentTemplate" DataType="vm:NodeBase">
            <Grid ColumnDefinitions="Auto,*">
                <Path IsVisible="{Binding Icon, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                     Width="14" Height="14"
                     Margin="0, 0, 6, 0"
                     Fill="{DynamicResource Brush.FG2}"
                     Data="{Binding Icon, Converter={StaticResource IconKeyConverter}}"/>
                <TextBlock Grid.Column="1"
                           VerticalAlignment="Center"
                           Text="{Binding Title}"
                           TextTrimming="CharacterEllipsis"
                           TextWrapping="NoWrap"
                           ClipToBounds="True" />
            </Grid>
        </DataTemplate>
    </Window.Resources>
    <Window.Styles>

    </Window.Styles>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="{Binding #WindowMain.CaptionHeight}"/>
            <RowDefinition Height="16" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <!-- Tabs or something -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,32,*,32,Auto">
            <Border Grid.Column="0" Grid.ColumnSpan="5"
                    DoubleTapped="MaximizeOrRestoreWindow"
                    PointerPressed="BeginMoveWindow"
                    Background="{DynamicResource Brush.TitleBar}"
                    BorderThickness="0,0,0,1" BorderBrush="{DynamicResource Brush.Border0}" />
            <!-- <Button Grid.Column="0">Open/Close/Resize Btns</Button> -->

            <Border Grid.Column="0" Width="72" IsVisible="{Binding #WindowMain.HasLeftCaptionButton}"/>
            
            <!-- Switch Mod Button  -->
            <Button Grid.Column="1" Classes="icon_button" Command="{Binding AddDevControlTab}">
                <Path Width="13" Height="13" Margin="0,2,0,0" Data="{StaticResource Icons.Settings}"/>
            </Button>

            <!-- Pages Tabs -->
            <views:TabBarView Grid.Column="2" Height="30" Margin="0,0,16,0" VerticalAlignment="Bottom" />

            
            <!-- Switch Tab  -->
            <Button Grid.Column="3" Classes="icon_button" VerticalAlignment="Bottom" Name="TabSwitcherFlyoutButton">
                <Path Width="13" Height="13" Margin="0,2,0,0" Data="{StaticResource Icons.Tabs}"/>
                <Button.Flyout>
                    <Flyout Placement="BottomEdgeAlignedRight"
                            Opened="FlyoutBase_OnOpened"
                            Closed="FlyoutBase_OnClosed">


                        <StackPanel Orientation="Vertical" Background="{DynamicResource Brush.Popup}">
                            <!-- Margin="8,16,8,8" Background="{DynamicResource Brush.Popup}" -->
                            <ContentControl Content="{Binding TabSwitcher}" Margin="8,8,8,8" />
                        </StackPanel>


                    </Flyout>

                </Button.Flyout>

            </Button>

        </Grid>
        <Grid Grid.Row="1">
            <Border Grid.Column="0" Grid.ColumnSpan="5"
                    Background="{DynamicResource Brush.ToolBar}"
                    BorderThickness="0,0,0,1" BorderBrush="{DynamicResource Brush.Border0}" />
            <TextBlock VerticalAlignment="Center" HorizontalAlignment="Center" FontFamily="Bold"
                       Text="Editing Mod: Halcyon" />
        </Grid>
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="200" MaxWidth="500" />
                <ColumnDefinition Width="3" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <!-- Left Side -->
            <Border Background="{DynamicResource Brush.Window}" Grid.Column="0" Margin="0,0,0,0" BorderThickness="1"
                    BorderBrush="{DynamicResource Brush.ToolBar}" CornerRadius="6">
                <Border Margin="8 8">
                    <Grid RowDefinitions="Auto,*">
                        <TextBox
                            FontSize="12"
                            Margin="0,6,0,0"
                            BorderThickness="1"
                            CornerRadius="4"
                            BorderBrush="{DynamicResource Brush.Border2}"
                            Watermark="Search..."
                            Text="{Binding Filter, Mode=TwoWay}"
                            VerticalContentAlignment="Center">
                            <TextBox.InnerLeftContent>
                                <Path
                                    Fill="{DynamicResource Brush.FG2}"
                                    Width="12" Height="12"
                                    Margin="6,0,0,0"
                                    Data="{StaticResource Icons.MagnifyingGlassFill}" />


                            </TextBox.InnerLeftContent>
                            <TextBox.InnerRightContent>
                                <Button Classes="icon_button"
                                        Width="16"
                                        Height="16"
                                        Margin="0,0,6,0"
                                        Command="{Binding ClearFilterCommand}"
                                        IsVisible="{Binding Filter, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                        HorizontalAlignment="Right">
                                    <Path
                                        Width="14" Height="14"
                                        Margin="0,1,0,0"
                                        Data="{StaticResource Icons.XCircleFill}" />
                                </Button>
                            </TextBox.InnerRightContent>
                        </TextBox>


                        <TreeView Classes="custom" Grid.Row="1" Margin="0"
                                  x:Name="MasterTreeView"
                                  ItemsSource="{Binding TreeSearch.Nodes}"
                                  SelectedItems="{Binding TreeSearch.SelectedNodes}"
                                  DoubleTapped="MasterTreeView_OnDoubleTapped"
                                  ScrollViewer.VerticalScrollBarVisibility="Auto"
                                  ScrollViewer.HorizontalScrollBarVisibility="Disabled">

                            <TreeView.Styles>
                                <Style Selector="TreeViewItem" x:DataType="vm:NodeBase">
                                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                                    <Setter Property="IsVisible" Value="{Binding IsVisible}" />
                                </Style>
                            </TreeView.Styles>
                            
                            <TreeView.DataTemplates>
                                <TreeDataTemplate DataType="vm:OpenEditorNode" ItemsSource="{Binding SubNodes}">
                                    <Grid ColumnDefinitions="*, Auto">
                                        <ContentPresenter Content="{Binding}"
                                                          ContentTemplate="{StaticResource NodeContentTemplate}" />

                                   
                                    </Grid>
                                </TreeDataTemplate>

                                
                                <!-- DataItemNode -->
                                <TreeDataTemplate DataType="vm:DataItemNode" ItemsSource="{Binding SubNodes}">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <ContentPresenter Content="{Binding}"
                                                          ContentTemplate="{StaticResource NodeContentTemplate}" />

                                        <ContentControl/>
                                        
                                        <Button Command="{Binding  $parent[TreeViewItem;1].((vm:DataRootNode)DataContext).AddCommand2}" Content="cc" />
                                    </StackPanel>
                                </TreeDataTemplate>
                                
                                <!-- ActionDataNode -->
                                <TreeDataTemplate DataType="vm:ActionDataNode" ItemsSource="{Binding SubNodes}">
                                    <Grid ColumnDefinitions="Auto, *, Auto">
                                        
                                        <ContentPresenter Content="{Binding}"
                                                          ContentTemplate="{StaticResource NodeContentTemplate}" />
                                        <Button Grid.Column="2" Classes="icon_button" Command="{Binding AddCommand}" >
                                            <Path x:Name="PART_IndicatorPlus"
                                                  Stretch="Fill"
                                                  Fill="{DynamicResource Brush.FG1}"
                                                  Width="6" Height="6" Margin="0,0,0,0"
                                                  Data="{StaticResource Icons.Plus}"/>
                                        </Button>
                                    </Grid>
                                    
                                    
                                </TreeDataTemplate>


                                <!-- Default Node -->
                                <TreeDataTemplate DataType="vm:NodeBase" ItemsSource="{Binding SubNodes}">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <ContentPresenter Content="{Binding}"
                                                          ContentTemplate="{StaticResource NodeContentTemplate}" />

                                        <ContentControl/>         
                                    </Grid>
                                </TreeDataTemplate>
                            </TreeView.DataTemplates>
                        </TreeView>

                    </Grid>
                </Border>
            </Border>

            <!--  Splitter -->
            <GridSplitter Grid.Column="1"
                          BorderBrush="{DynamicResource Brush.Border0}"
                          Background="Transparent"
                          MinWidth="1"
                          HorizontalAlignment="Stretch" VerticalAlignment="Stretch"

                          BorderThickness="0,0,1,0" />

            <!-- Editor Panel -->
            <StackPanel Grid.Column="2">
                <ContentControl Grid.Row="1" Content="{Binding TemporaryTab}"/>
                <ContentControl Grid.Row="1" Content="{Binding ActivePage}" IsVisible="{Binding TemporaryTab, Converter={x:Static ObjectConverters.IsNull}}"/>

                <!-- ~1~ Page @1@ -->
                <!-- <ContentControl Grid.Row="1" Content="{Binding ActivePage}"> -->
                <!--     <ContentControl.DataTemplates> -->
                <!--         <DataTemplate DataType="vm:LauncherPage"> -->
                <!--             <v:LauncherPage/> -->
                <!--         </DataTemplate> -->
                <!--     </ContentControl.DataTemplates> -->
                <!-- </ContentControl> -->
                <!-- -->
                <!-- ~1~ Workspace/Pages Switcher @1@ -->
                <!-- <Border Grid.Row="0" Grid.RowSpan="2" -->
                <!--         Background="Transparent" -->
                <!--         IsVisible="{Binding Switcher, Converter={x:Static ObjectConverters.IsNotNull}}" -->
                <!--         PointerPressed="OnCancelSwitcher"> -->
                <!--     <Border HorizontalAlignment="Center" VerticalAlignment="Center" Effect="drop-shadow(0 0 12 #A0000000)"> -->
                <!--         <Border Background="{DynamicResource Brush.Popup}" CornerRadius="8"> -->
                <!--f                 <ContentControl.DataTemplates> -->
                <!--                     <DataTemplate DataType="vm:WorkspaceSwitcher"> -->
                <!--                         <v:WorkspaceSwitcher/> -->
                <!--                     </DataTemplate> -->
                <!-- -->
                <!--                     <DataTemplate DataType="vm:LauncherPageSwitcher"> -->
                <!--                         <v:LauncherPageSwitcher/> -->
                <!--                     </DataTemplate> -->
                <!--                 </ContentControl.DataTemplates> -->
                <!--             </ContentControl> -->
                <!--         </Border> -->
                <!--     </Border> -->
                <!-- </Border> -->
            </StackPanel>


        </Grid>


    </Grid>

</v:ChromelessWindow>